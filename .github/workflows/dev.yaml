name: 'Terraform - Production'

on:
  push:
    branches:
    - main
    paths: 
    - dev/**
  pull_request:
    branches:
    - main
    paths: 
    - dev/**

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.aws_access_key }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.aws_secret_key }}

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
       
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1
      
      - name: install python packages
        run: |
          python -m pip install --upgrade pip
          pip install pyhcl
          
      - name: lint
        run: |
          cp lint.py dev/
          python lint.py
          working-directory: ./dev
      
      - name: Terraform formate
        id: formate
        run: |
          terraform fmt -diff -write=true -recursive .
          terraform fmt
          working-directory: ./dev
      
      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ./dev
      
      - name: Terraform validate
        id: validate
        run: terraform validate
        working-directory: ./dev
